{% extends "main.html" %}
{% load static %}

{% block "links" %}
<link href="{% static "css/dropZoneFile.css" %}" rel="stylesheet">
<link href="{% static "css/dropZone.css" %}" rel="stylesheet">
{% endblock %}

{% block "scripts" %}
<script src="{% static "js/dropZoneFile.js" %}" defer></script>
<script src="{% static "js/dropZone.js" %}" defer></script>
<script src="{% static "lib/jszip.min.js" %}" defer></script>
{% endblock %}

{% block "main-content" %}

<!-- Navigation -->
<a class="link-dark ps-2" style="text-decoration: none;" href="{% url "jobs:index" %}">
	Home 
	<svg class="m-1" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 19">
	<path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
  	</svg> 
  	Jobs
</a> 

<!-- Page Title -->
<h2 class="py-2 px-1 text-bold">
	<b>Submitted Jobs</b>
</h2>

<!-- Content -->
<div class="container-fluid shadow-sm bg-white py-3 px-4 rounded-3">

<!-- Search/Create -->
<div class="row mb-3">
	<div class="col-lg-12">
		<div class="input-group px-1 pt-2 justify-content-between">
			<input class="form-control me-2 rounded" type="search" placeholder="Search..." aria-label="Search">
			<span class="input-group-btn">
				<button type="button" class="btn btn-primary text-light rounded-pill" data-bs-toggle="modal" data-bs-target="#createJob">
					<svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" fill="currentColor" class="bi bi-plus" viewBox="4 2.5 13 13">
						<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
					  </svg>
					Create Job</button>
			</span>
		</div>
	</div>
</div>

<!-- Table -->
<table id="job-table" class="table table-hover table-striped border rounded-3" style="background-color: white">

	<!-- Headings -->
	<thead class="table-dark">
		<tr>
			<th scope="col" style="width: 30%">Name</th>
			<th scope="col" style="width: 30%">Language</th>
			<th scope="col" style="width: 30%">Date Created</th>
			<th scope="col" style="width: 10%">Status</th>
		</tr>
	</thead>
	
	<!-- Jobs -->
	<tbody>
	</tbody>

</table>

<div id="no-jobs-message" class="container text-center" style="display: none">No jobs have been created yet!</div>

<!-- Modal -->
<div class="modal fade" id="createJob" tabindex="-1" aria-labelledby="createJobLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<form id="create-job-form">

				{% csrf_token %}

				<div class="modal-header">
					<h5 class="modal-title" id="createJobLabel">Create Job</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>

				<div class="modal-body" id="create-job-body">

					<!-- Drop Zone -->
					<div class="mb-3">
						<drop-zone id="drop-zone"></drop-zone>
					</div>

					<!-- Name -->
					<div class="mb-3">
						<label for="job-name">Name:</label>
						<input class="form-control" id="job-name" type="text" name="job-name" autocomplete="off" data-lpignore="true" data-form-type="text">
					</div>

					<!-- Language -->
					<div class="mb-3">
						<label for="job-language">Language:</label>
						<select class="form-select" id="job-language" name="job-language" data-form-type="other">
							{% for language, info in SUPPORTED_LANGUAGES.items %}
								<option language-id={{language}}>{{info.0}} </option>
							{% endfor %}
						</select>
					</div>

					<!-- Max until ignored -->
					<div class="mb-3">
						<label for="job-max-until-ignored">Max matches until ignored:</label>
						<input class="form-control" id="job-max-until-ignored" type="number" name="job-max-until-ignored" value="{{ DEFAULT_MOSS_SETTINGS.max_until_ignored }}">
					</div>

					<!-- Max displayed matches -->
					<div class="mb-3">
						<label for="job-max-displayed-matches">Max matches displayed:</label>
						<input class="form-control" id="job-max-displayed-matches" type="number" name="job-max-displayed-matches" value="{{DEFAULT_MOSS_SETTINGS.max_displayed_matches}}">
					</div>
				</div>

				<div class="modal-footer">
					<div style="position: relative; min-height: 40px;">
						<button id="create-job-button" type="submit" class="btn btn-primary" data-bs-dismiss="modal" disabled>Create</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
</div>

<script>
window.addEventListener('DOMContentLoaded', function(){

	const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

	const container = document.getElementById('createJob');
	const modal = new bootstrap.Modal(container);
	
	let languageSelect = document.getElementById('job-language')
	let jobName = document.getElementById('job-name');
	let maxMatchesUntilIgnored = document.getElementById('job-max-until-ignored');
	let maxMatchesDisplayed = document.getElementById('job-max-displayed-matches');
	let createJobButton = document.getElementById('create-job-button');


	let jobTable = document.getElementById('job-table')

	function addJob(job){
		jobTable.getElementsByTagName('tbody')[0].prepend(new Job(job))
	}

	let languages = {{ SUPPORTED_LANGUAGES | js }};
	let statuses = {{ STATUSES | js }};


	let completedStatus = "{{ COMPLETED_STATUS }}";
	let processingStatus = "{{ PROCESSING_STATUS }}";
	let uploadingStatus = "{{ UPLOADING_STATUS }}";
	let failedStatus = "{{ FAILED_STATUS }}";

	class Job extends HTMLTableRowElement{
		constructor(obj) {
			super()
			Object.assign(this, obj)

			this.setAttribute('job_id', obj.job_id)
			this.setAttribute('status', obj.status)

			this.tableComment = document.createElement('td')
			this.tableComment.innerHTML = this.comment;
			
			this.tableLanguage = document.createElement('td')
			this.tableLanguage.innerHTML = languages[this.language][0];

			this.tableStartDate = document.createElement('td')
			this.tableStartDate.innerHTML = new Date(this.start_date).toLocaleString();
			
			let tableStatusCell = document.createElement('td')
			this.tableStatus = document.createElement('span')
			tableStatusCell.append(this.tableStatus)
			
			this.append(this.tableComment)
			this.append(this.tableLanguage)
			this.append(this.tableStartDate)
			this.append(tableStatusCell)

			this.setStatus(this.status)
		}

		setStatus(newStatus){
			this.tableStatus.innerHTML = statuses[newStatus]
			if(newStatus == completedStatus){
				this.tableComment.innerHTML = `<a href="/jobs/${this.job_id}/result/" class="text-primary" style="text-decoration: none;">${this.comment}</a>`
			}

			this.tableStatus.className = '';
			
			let classes = ['badge'];
			switch(newStatus){
				
				case completedStatus:
					classes.push('bg-success')
					break;
				case processingStatus:
					classes.push('bg-info')
					break;
				case uploadingStatus:
					classes.push('bg-warning')
					break;
				
				default:
					classes.push('bg-danger')
					break;
			}

			this.tableStatus.classList.add(...classes)
		}
	}
	customElements.define('job-row', Job, { extends: 'tr' });

	let unfinishedJobs = [];
	let result = fetch("{% url "api:jobs:get_jobs" %}", {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
			'X-CSRFToken': csrftoken
		}
	}).then(async (response)=>{
		let json = await response.json()

		json.forEach(item => {
			addJob(item);
			if (!isTerminalState(item.status)){
				unfinishedJobs.push(item.job_id)
			}
		});
		if(json.length == 0){
			document.getElementById('no-jobs-message').style.display = 'block'
		}
	});
	let terminalStates = [completedStatus, failedStatus];
	function isTerminalState(state){
		return terminalStates.includes(state)
	}
	
	setInterval(async function(){
		if(unfinishedJobs.length == 0){
			// Do not make any request if all jobs are finished
			return;
		}
		let result = await fetch("{% url "api:jobs:get_statuses" %}", {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': csrftoken
			},
			body: JSON.stringify({
				'job_ids': unfinishedJobs
			})
		})

		let json = await result.json();

		for (let key in json) {
			var value = json[key];

			document.querySelector(`tr[job_id="${key}"]`).setStatus(value)
			if(isTerminalState(value)){
				unfinishedJobs = unfinishedJobs.filter(item => item !== key)
			}
		}
		
		// TODO update jobs information
	},{{ POLLING_TIME }});

    let form = document.getElementById('create-job-form')


    // TODO increase list

	function getExtension(name){
		return name.split('.').pop();
	}

	// TODO
	{% comment %} data.append("{{ BASE_FILES_NAME }}", blob, zipEntry.name) {% endcomment %}

	const dropzone = document.getElementById('drop-zone')
	// https://stackoverflow.com/a/50472925
	form.onsubmit = async (e) => {

		e.preventDefault();

		// Construct new form with relevant data
		let data = new FormData(form);

		// Read zip file
		let zipFile = dropzone.files[0].file;
		if (!zipFile) {
			// TODO - display error, no files
			return;
		}
		let zip = await JSZip.loadAsync(zipFile);

		console.log(zip);

		let files = [];
		zip.forEach(function (relativePath, file) {
			files.push(file)
		});

		await Promise.all(files.map(async (zipEntry) => {

			let languageID =languageSelect.options[languageSelect.selectedIndex].getAttribute('language-id')

			let extension = getExtension(zipEntry.name);

			// TODO do not upload if no valid files found
			let validFile = languages[languageID][2].includes(extension);
			if (validFile) {
				let blob = await zipEntry.async('blob')
				data.append("{{ FILES_NAME }}", blob, zipEntry.name)
				console.log('valid file:', zipEntry.name);

			} else {
				console.log('invalid file:', zipEntry.name);
			}
		}))

		console.log(data)

		
		let result = await fetch("{% url "jobs:new" %}", {
			method: 'POST',
			body: data,
		})

		let json = await result.json();

		document.getElementById('no-jobs-message').style.display = 'none'
		addJob(json)

		// Hide modal on successful post
		modal.hide()

		unfinishedJobs.push(json['job_id'])



		// RESET
		form.reset();
		dropzone.reset();
	};


	function updateFormData(){


		if (dropzone.files.length > 0)
		{
			zipFile = dropzone.files[0].file; // TODO just first for now...

			// name
			jobName.value = jobName.value || zipFile.name.slice(0, zipFile.name.length - 4);

			// programming language
			JSZip.loadAsync(zipFile).then((zip)=>{
				
				// initialise counts:
				let d = {};
				for (let key in languages){
					d[key] = 0;
				}

				zip.forEach(function (relativePath, file) {
					let extension = getExtension(file.name);

					for (let key in languages){
						console.log()
						if(languages[key][2].includes(extension)){
							d[key] += 1;
						}
					}
				});

				let bestID = Object.entries(d).reduce((a, b) => a[1] > b[1] ? a : b)[0]
				languageSelect.value = languages[bestID][0];
			});

			createJobButton.disabled = false;
		}
		else
		{
			jobName.value = "";
			languageSelect.selectedIndex = 0;
			maxMatchesUntilIgnored.value = {{ DEFAULT_MOSS_SETTINGS.max_until_ignored }};
			maxMatchesDisplayed.value = {{ DEFAULT_MOSS_SETTINGS.max_displayed_matches }};

			createJobButton.disabled = true;
		}
	}

	dropzone.onFileAdded = () =>
	{
		updateFormData();
	};

	dropzone.onFileRemoved = () =>
	{
		updateFormData();
	};

})
</script>


{% endblock %}