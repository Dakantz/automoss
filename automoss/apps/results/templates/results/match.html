{% extends "main.html" %}
{% load static %}

{% block "main-content" %}

<link rel="stylesheet"
	  href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/github.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>

{{submissions}}
{{match_info}}

<style>
pre {
	float: left;
	min-width: 100%;
	margin:0;
}
.match {
	transition: all ease-out 0.1s;
}
.code-window{
	position:relative;
}
</style>

<div class="container d-flex shadow" style="background-color:white;padding:0; max-height: calc(100vh - 350px)">
	{% for key, values in blocks.items %}
	<div class="code-window w-50" style="overflow-x:auto; border: solid 1px">
		{% for x in values %}
			<pre {% if x.id %} match="{{x.id}}" class="language-{{language}} match" {% else %} class="language-{{language}}" {% endif %}>{{x.text}}</pre>
		{% endfor %}
	</div>
	{% endfor %}
</div>
<button class="btn btn-primary" onClick="downloadAsPDF();">Download</button>

<script src="{% static "lib/html2canvas.min.js" %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

<script>
	hljs.configure({
		cssSelector: 'pre'
	})
	hljs.highlightAll();

	let colours = {{ colours | js }};

	let hoverOpacity = 0.5;
	let defaultOpacity = 0.2;
	function setMatches(matchID, opacity){
		document.querySelectorAll(`.match[match="${matchID}"]`).forEach(x=>{
			x.style.backgroundColor = `rgba(${colours[matchID % colours.length]}, ${opacity})`;
		})
	}
	document.querySelectorAll(".match").forEach(m => {
		let matchID = m.getAttribute('match');

		m.addEventListener("mouseover", e => {
			setMatches(matchID, hoverOpacity);
		});
		
		m.addEventListener("mouseout", e => {
			setMatches(matchID, defaultOpacity);
		});
		m.addEventListener("click", e => {
			document.querySelectorAll(`.match[match="${matchID}"]`).forEach(x=>{
				let parent = x.closest('.code-window');

				let toScrollTo = 0;
				if(x.offsetHeight > parent.offsetHeight){
					toScrollTo = x.offsetTop; // - 10;
				}else{
					toScrollTo = x.offsetTop - (parent.offsetHeight - x.offsetHeight)/2;
				}
				parent.scrollTo({top: toScrollTo, left: 0, behavior: 'smooth'});
			})
		}); 
		setMatches(matchID, defaultOpacity)
	});

	async function downloadAsPDF(){
		var jsPDF = window.jspdf.jsPDF;

		const report = new jsPDF('portrait', 'pt', 'a4');

		const reportWidth = report.internal.pageSize.getWidth();
		const reportHeight = report.internal.pageSize.getHeight();

		let content = document.createElement("div");
		content.classList.add("p-3");
		content.style.width = `${reportWidth}px`;
		content.style.height = `${reportHeight}px`;

		let matches = {}
		document.querySelectorAll(".match").forEach(match => {
			let matchID = match.getAttribute('match');
			let pair = matches[matchID];
			if (pair == null){
				matches[matchID] = pair = [];
			}
			pair.push(match);
		});

		for (let matchID of Object.keys(matches)){
			
			let codeComparison = document.createElement("div");
			content.append(codeComparison);

			let title = document.createElement("h4");
			title.textContent = `Match #${matchID}`;
			codeComparison.append(title);
			codeComparison.classList.add("pb-2");
			codeComparison.classList.add("d-flex");
			codeComparison.classList.add("flex-column");

			let pair = matches[matchID];
			for (let match of pair){
				await html2canvas(match).then(function(canvas){
					let image = document.createElement("img");
					image.classList.add("pb-1");
					image.setAttribute("src", canvas.toDataURL("image/png"));			
					codeComparison.append(image);
				});
			}
		}

		report.html(content, {
			callback: function(r){
				r.save("report.pdf");
			}
		})
	}

</script>

{% endblock %}